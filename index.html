<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard รายชื่อผู้ต้องการความช่วยเหลือ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 1200px;
      margin: auto;
      padding: 20px;
    }

    h1 {
      font-size: 26px;
      font-weight: 600;
      margin-bottom: 18px;
      color: #222;
    }

    .toolbar {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
    }

    .toolbar input, .toolbar select {
      padding: 10px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #ccc;
      width: 100%;
    }

    .table-wrapper {
      background: #fff;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th {
      background: #fafafa;
      padding: 10px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid #eee;
      white-space: nowrap;
    }

    td {
      padding: 10px;
      border-bottom: 1px solid #eee;
      vertical-align: top;
    }

    .urgent-row {
      background: #ffe1e1 !important;
    }

    textarea {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      min-height: 50px;
      resize: vertical;
    }

    button.save-btn {
      margin-top: 4px;
      padding: 6px 12px;
      border: none;
      background: #0066ff;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
    }

    button.save-btn:hover {
      background: #0052cc;
    }

    .status-text {
      font-size: 11px;
      color: #555;
      margin-top: 3px;
    }

  </style>
</head>
<body>

<div class="container">
  <h1>Dashboard รายชื่อผู้ต้องการความช่วยเหลือ</h1>

  <div class="toolbar">
    <input id="searchInput" placeholder="ค้นหาชื่อ / ที่อยู่ / อาการ / หมายเหตุ..." />
    <select id="urgencyFilter">
      <option value="">ทุกความเร่งด่วน</option>
      <option value="normal">ปกติ</option>
      <option value="urgent">เร่งด่วน</option>
    </select>
  </div>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>ลำดับ</th>
          <th>Case</th>
          <th>ที่อยู่</th>
          <th>จำนวนผู้อยู่</th>
          <th>อาการ</th>
          <th>ผู้ติดต่อ</th>
          <th>แผนที่</th>
          <th>Note (ระบบ)</th>
          <th>เร่งด่วน</th>
          <th>หมายเหตุ (ผู้ใช้)</th>
        </tr>
      </thead>
      <tbody id="casesTbody"></tbody>
    </table>
  </div>
</div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx50ejMtzTemFSl4ErrigZFtoU9XbF9ew_5a2Ipppc1jJDBWBlD32iYfYzTnY5Dcqqc/exec";

  let allCases = [];

  function escapeHtml(str) {
    return String(str || "").replace(/[&<>"]/g, c => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;"
    }[c]));
  }

  async function loadData() {
    const res = await fetch(SCRIPT_URL);
    const json = await res.json();
    if (!json.success) return alert("โหลดข้อมูลจาก Google Sheet ไม่สำเร็จ");

    allCases = json.data.map(r => ({
      id: r["ลำดับ"],
      caseName: r["Case"],
      address: r["ที่อยู่ / พิกัด"],
      people: r["จำนวนผู้อยู่ในบ้าน"],
      status: r["สถานะ / อาการ"],
      contact: r["ผู้ติดต่อ"],
      mapLink: r["ลิงก์แผนที่"],
      note: r["Note"],
      userNote: r["หมายเหตุ"],
      urgency: r["ความเร่งด่วน"] || "normal"
    }));

    renderTable(allCases);
  }

  function renderTable(data) {
    const tbody = document.getElementById("casesTbody");
    tbody.innerHTML = "";

    data.forEach(item => {
      const tr = document.createElement("tr");
      if (item.urgency === "urgent") tr.classList.add("urgent-row");

      tr.innerHTML = `
        <td>${item.id}</td>
        <td>${escapeHtml(item.caseName)}</td>
        <td>${escapeHtml(item.address)}</td>
        <td>${escapeHtml(item.people)}</td>
        <td>${escapeHtml(item.status)}</td>
        <td>${escapeHtml(item.contact)}</td>
        <td>${item.mapLink ? `<a href="${item.mapLink}" target="_blank">แผนที่</a>` : "-"}</td>
        <td>${escapeHtml(item.note)}</td>

        <td>
          <select onchange="changeUrgency('${item.id}', this.value)">
            <option value="normal" ${item.urgency === "normal" ? "selected" : ""}>ปกติ</option>
            <option value="urgent" ${item.urgency === "urgent" ? "selected" : ""}>เร่งด่วน</option>
          </select>
        </td>

        <td>
          <textarea id="note-${item.id}">${escapeHtml(item.userNote)}</textarea>
          <button class="save-btn" onclick="saveNote('${item.id}')">บันทึก</button>
          <div class="status-text" id="status-${item.id}"></div>
        </td>
      `;

      tbody.appendChild(tr);
    });
  }

  function changeUrgency(id, value) {
    const row = [...document.querySelectorAll("#casesTbody tr")]
      .find(r => r.children[0].textContent.trim() === id);

    if (!row) return;
    if (value === "urgent") row.classList.add("urgent-row");
    else row.classList.remove("urgent-row");
  }

  async function saveNote(id) {
    const urgency = document.querySelector(`select[onchange="changeUrgency('${id}', this.value)"]`).value;
    const note = document.getElementById(`note-${id}`).value;

    const body = new URLSearchParams();
    body.append("id", id);
    body.append("note", note);
    body.append("urgency", urgency);

    const res = await fetch(SCRIPT_URL, { method: "POST", body });
    const json = await res.json();

    const status = document.getElementById(`status-${id}`);
    if (json.success) {
      status.textContent = "บันทึกแล้ว";
      setTimeout(() => status.textContent = "", 2000);
    } else {
      status.textContent = "บันทึกผิดพลาด";
    }
  }

  function applyFilters() {
    const text = document.getElementById("searchInput").value.toLowerCase();
    const urgency = document.getElementById("urgencyFilter").value;

    const filtered = allCases.filter(c => {
      if (urgency && c.urgency !== urgency) return false;

      return [
        c.caseName,
        c.address,
        c.people,
        c.status,
        c.contact,
        c.note,
        c.userNote,
      ].join(" ").toLowerCase().includes(text);
    });

    renderTable(filtered);
  }

  document.getElementById("searchInput").addEventListener("input", applyFilters);
  document.getElementById("urgencyFilter").addEventListener("change", applyFilters);

  loadData();
</script>

</body>
</html>
